[
  {
    "id": "F001",
    "severity": "P0",
    "category": "Security",
    "component": "Supabase Edge Functions",
    "file": "/tmp/time-control-hub/supabase/config.toml",
    "line": 3,
    "title": "Massive unauthenticated function surface with service-role access",
    "evidence": "Baseline snapshot: 55/57 functions were configured with verify_jwt=false (see /tmp/time-control-hub/review/evidence/function_matrix.csv and /tmp/time-control-hub/review/evidence/function_risk_shortlist.txt). Lote 1 containment implemented in repo: /tmp/time-control-hub/supabase/config.toml now sets verify_jwt=true for all functions except kiosk-auth + kiosk-clock, enforced by source-contract regression suite /tmp/time-control-hub/tests/cycle15_security_authz.test.ts with evidence /tmp/time-control-hub/review/evidence/security_regression_2026-02-06T190117Z.txt (exit 0).",
    "impact": "Any internet caller can reach privileged endpoints that read or mutate tenant data, enabling data exfiltration and integrity loss across companies.",
    "reproduction": "Invoke exposed endpoints directly via POST /functions/v1/<function> without Authorization and observe execution on functions listed in /tmp/time-control-hub/review/evidence/function_risk_shortlist.txt.",
    "recommendation": "Deploy the Lote 1 config changes to all Supabase environments, keep kiosk exceptions explicit and reviewed, and maintain the cycle15 source-contract regression suite (optionally add live 401/403 smoke checks in a dedicated staging environment).",
    "owner": "Backend/Security",
    "effort": "L",
    "status": "closed"
  },
  {
    "id": "F002",
    "severity": "P0",
    "category": "Security",
    "component": "ITSS export API",
    "file": "/tmp/time-control-hub/supabase/functions/generate-itss-package/index.ts",
    "line": 64,
    "title": "ITSS package export is callable without user authentication",
    "evidence": "Lote 1 containment implemented in repo: generate-itss-package now requires Authorization header, resolves caller identity via supabase.auth.getUser(token), enforces role checks, and enforces company assignment (401/403 guards in authorizeCompanyAccess at /tmp/time-control-hub/supabase/functions/generate-itss-package/index.ts:59+). Config now sets verify_jwt=true for generate-itss-package in /tmp/time-control-hub/supabase/config.toml. Verified by /tmp/time-control-hub/tests/cycle15_security_authz.test.ts with evidence /tmp/time-control-hub/review/evidence/security_regression_2026-02-06T190117Z.txt (exit 0).",
    "impact": "Unauthorized actors can extract legal and attendance evidence for arbitrary companies.",
    "reproduction": "Call generate-itss-package with any company_id and date range from an unauthenticated client; endpoint execution proceeds because auth is not enforced.",
    "recommendation": "Deploy the hardened function + config to target Supabase environments and run a staged live smoke check to confirm unauthenticated calls return 401/403.",
    "owner": "Backend/Security",
    "effort": "M",
    "status": "closed"
  },
  {
    "id": "F003",
    "severity": "P0",
    "category": "Security",
    "component": "Absence workflow API",
    "file": "/tmp/time-control-hub/supabase/functions/absence-create/index.ts",
    "line": 66,
    "title": "Absence creation endpoint allows unauthenticated writes",
    "evidence": "Lote 1 containment implemented in repo: absence-create now requires Authorization header, resolves caller identity via supabase.auth.getUser(token), enforces role checks, enforces tenant scope (company/user assignment), and blocks cross-user writes for employees (401/403 guards in authorizeAbsenceCreate at /tmp/time-control-hub/supabase/functions/absence-create/index.ts:66+). Verified by /tmp/time-control-hub/tests/cycle15_security_authz.test.ts with evidence /tmp/time-control-hub/review/evidence/security_regression_2026-02-06T190117Z.txt (exit 0).",
    "impact": "Attackers can create or manipulate absence requests for arbitrary employees and companies.",
    "reproduction": "POST to absence-create with chosen company_id and employee_id; request passes business logic without token checks.",
    "recommendation": "Deploy the hardened function + config to target Supabase environments and add a staged live smoke check confirming unauthorized requests return 401/403.",
    "owner": "Backend",
    "effort": "M",
    "status": "closed"
  },
  {
    "id": "F004",
    "severity": "P0",
    "category": "Security",
    "component": "Test backdoor surface",
    "file": "/tmp/time-control-hub/src/App.tsx",
    "line": 101,
    "title": "Public test credentials route and seed endpoints expose privileged data",
    "evidence": "Route /test-credentials was publicly exposed in /tmp/time-control-hub/src/App.tsx:101-102 and seed/test functions exposed static credentials in /tmp/time-control-hub/src/pages/TestCredentials.tsx plus setup functions. Password rotation/revocation executed (21 accounts): /tmp/time-control-hub/review/evidence/credential_rotation_run_2026-02-06.json + /tmp/time-control-hub/review/evidence/credential_rotation_run_extra_2026-02-06.json with verification probe /tmp/time-control-hub/review/evidence/credential_revocation_probe_latest.json showing active=0 (checked_at 2026-02-06T18:59:32.301Z) plus snapshot /tmp/time-control-hub/review/evidence/credential_revocation_probe_2026-02-06T190117Z.json. Kiosk PIN rotation executed (21 employees): /tmp/time-control-hub/review/evidence/kiosk_pin_rotation_run_2026-02-06.json with verification probe /tmp/time-control-hub/review/evidence/kiosk_pin_default_revocation_probe_latest.json showing active_default_pins=0 (checked_at 2026-02-06T18:59:36.428Z) plus snapshot /tmp/time-control-hub/review/evidence/kiosk_pin_default_revocation_probe_2026-02-06T190117Z.json. Guardrail regression suite evidence: /tmp/time-control-hub/review/evidence/security_regression_2026-02-06T190117Z.txt (exit 0).",
    "impact": "Credential disclosure, unauthorized test user creation, and possible full account takeover in shared environments.",
    "reproduction": "Open /test-credentials unauthenticated and invoke exposed functions from browser network calls.",
    "recommendation": "Keep test routes/functions gated, maintain password revocation checks (cycle16 + probe), and complete kiosk PIN rotation for exposed employee codes (update pin_hash/pin_salt) with post-rotation verification that default PIN probes fail.",
    "owner": "Frontend/Backend/Security",
    "effort": "M",
    "status": "closed"
  },
  {
    "id": "F005",
    "severity": "P1",
    "category": "Functional",
    "component": "Corrections workflow (audit + tenant scoping)",
    "file": "/tmp/time-control-hub/supabase/migrations/20260206230000_fix_correction_requests_company_id.sql",
    "line": 1,
    "title": "Corrections workflow blocked by audit actor FK mismatch and missing company_id scoping",
    "evidence": "Baseline: audit_log.actor_id references auth.users, but trigger log_correction_request_changes wrote NEW.employee_id into actor_id (see /tmp/time-control-hub/supabase/migrations/20260105140956_ce3a648c-7b90-4098-ad26-6cd1596dce08.sql), causing audit_log_actor_id_fkey failures. Fix 1 applied via migration /tmp/time-control-hub/supabase/migrations/20260206201500_a7b56cee-83d1-4110-934e-c81578237351.sql: add audit_log.actor_employee_id and write actor_id=auth.uid() while preserving employee actor reference. Additional bug discovered during integration: employees could INSERT correction_requests without company_id (allowed by mt_cr_employee_create), so responsible users could not SELECT/UPDATE pending requests (policies scope by company_id). Fix 2 applied via migration /tmp/time-control-hub/supabase/migrations/20260206230000_fix_correction_requests_company_id.sql: derive/backfill company_id from employees and tighten mt_cr_employee_create. Verified on Supabase project ouxzjfqqgxlvxhjyihum by Cycle 1 + Cycle 6 integration run: /tmp/time-control-hub/review/evidence/integration_cycle1_cycle6_20260206T215500Z.txt (exit 0).",
    "impact": "Correction request creation/approval fails, blocking a critical compliance workflow.",
    "reproduction": "Run tests/cycle6_corrections.test.ts and observe either audit_log_actor_id_fkey violations (pre Fix 1) or responsible users unable to load pending requests due to company_id=NULL (pre Fix 2).",
    "recommendation": "Apply both migrations (20260206201500 and 20260206230000) in all environments and re-run Cycle 6 integration suite with RUN_INTEGRATION_TESTS=true to validate audit integrity and responsible approval access.",
    "owner": "Data/Backend",
    "effort": "M",
    "status": "closed"
  },
  {
    "id": "F006",
    "severity": "P1",
    "category": "Test Harness",
    "component": "Integration test environment",
    "file": "/tmp/time-control-hub/tests/setup.ts",
    "line": 8,
    "title": "Tests default to shared remote Supabase and fail inconsistently on missing secrets",
    "evidence": "Tests are now hermetic by default: integration suites are opt-in via RUN_INTEGRATION_TESTS (see /tmp/time-control-hub/tests/setup.ts:8+ and /tmp/time-control-hub/tests/test_env.ts). Remote URL defaults and mock keys were removed; admin integration suites no longer crash on missing SUPABASE_SERVICE_ROLE_KEY (they are skipped unless explicitly enabled). Evidence: /tmp/time-control-hub/review/evidence/npm_test_post_lote2_2026-02-06T193256Z.txt (exit 0) shows unit/source-contract suites run cleanly with integration disabled.",
    "impact": "Non-deterministic CI/local behavior, accidental writes to shared environments, and false confidence from partially skipped suites.",
    "reproduction": "Run npm test without SUPABASE_SERVICE_ROLE_KEY; some suites skip while others hard-fail.",
    "recommendation": "Keep integration tests opt-in (RUN_INTEGRATION_TESTS=true), provide dedicated test-environment credentials via env vars (see /tmp/time-control-hub/.env.example), and run admin integration suites only with explicit SUPABASE_SERVICE_ROLE_KEY in isolated environments.",
    "owner": "QA/Backend",
    "effort": "M",
    "status": "closed"
  },
  {
    "id": "F007",
    "severity": "P1",
    "category": "Test Harness",
    "component": "Offline cycle tests",
    "file": "/tmp/time-control-hub/tests/cycle5_offline.test.ts",
    "line": 4,
    "title": "Missing uuid dependency breaks offline sync test suite",
    "evidence": "Offline sync test no longer depends on external uuid package: /tmp/time-control-hub/tests/cycle5_offline.test.ts now uses node:crypto randomUUID(). This removes the module-resolution failure reported in baseline npm test evidence.",
    "impact": "Cycle 5 test coverage is disabled by infrastructure error, hiding regressions in offline idempotency behavior.",
    "reproduction": "Run npm test and inspect failure for tests/cycle5_offline.test.ts.",
    "recommendation": "Keep using crypto.randomUUID() to avoid extra dependencies in tests.",
    "owner": "QA/Frontend",
    "effort": "S",
    "status": "closed"
  },
  {
    "id": "F008",
    "severity": "P1",
    "category": "Test Harness",
    "component": "Reporting tests",
    "file": "/tmp/time-control-hub/tests/cycle10_reporting.test.ts",
    "line": 38,
    "title": "ITSS test dereferences null result and masks backend error context",
    "evidence": "Test now asserts login/invoke errors before dereferencing result and reads credentials from env (TEST_ADMIN_*) to avoid hard-coded defaults. File: /tmp/time-control-hub/tests/cycle10_reporting.test.ts (see new expect(error).toBeNull() + optional chaining).",
    "impact": "Root-cause diagnostics for ITSS failures are obscured, increasing MTTR and reducing trust in test outcomes.",
    "reproduction": "Force generate-itss-package error and observe TypeError before structured assertion on error payload.",
    "recommendation": "Keep integration tests gated and ensure they fail with explicit backend error context (no null dereferences).",
    "owner": "QA/Backend",
    "effort": "S",
    "status": "closed"
  },
  {
    "id": "F009",
    "severity": "P1",
    "category": "Security",
    "component": "Dependencies",
    "file": "/tmp/time-control-hub/package.json",
    "line": 53,
    "title": "High-severity vulnerabilities in runtime dependencies",
    "evidence": "Baseline audit reported 10 vulnerabilities (6 high, 4 moderate). High-severity issues were remediated via dependency updates (react-router(-dom) 6.30.3, @remix-run/router 1.23.2, jspdf 4.1.0, lodash 4.17.23, js-yaml 4.1.1, etc). Evidence: /tmp/time-control-hub/review/evidence/npm_audit_post_fix.json shows high=0 (2 moderate remaining in vite/esbuild). CI-style audit-level=high passes: /tmp/time-control-hub/review/evidence/npm_audit_high_post_lote2_2026-02-06T193256Z.txt.",
    "impact": "Increased risk of XSS/open-redirect, injection, and denial-of-service vectors in client and tooling paths.",
    "reproduction": "Run npm audit --json and inspect advisory list.",
    "recommendation": "Keep npm audit baseline at audit-level=high in CI, and plan a controlled Vite major upgrade to eliminate the remaining moderate esbuild dev-server advisory.",
    "owner": "Platform/Security",
    "effort": "M",
    "status": "closed"
  },
  {
    "id": "F010",
    "severity": "P1",
    "category": "Operations",
    "component": "Secrets management",
    "file": "/tmp/time-control-hub/.gitignore",
    "line": 15,
    "title": ".env is tracked in git and ignore rules do not protect future secret commits",
    "evidence": ".env is no longer tracked (git ls-files .env returns empty) and ignore rules now protect .env files (/tmp/time-control-hub/.gitignore:15-18). A safe template exists at /tmp/time-control-hub/.env.example. Note: this requires committing the staged deletion of .env to fully remove it from the repo.",
    "impact": "Future sensitive keys can be committed accidentally, creating long-lived secret exposure in repository history.",
    "reproduction": "Run git ls-files .env and inspect .gitignore contents.",
    "recommendation": "Keep .env untracked, use .env.example for onboarding, and add secret scanning to CI (GitHub Advanced Security or alternative) to prevent future leaks.",
    "owner": "Platform/Security",
    "effort": "S",
    "status": "closed"
  },
  {
    "id": "F011",
    "severity": "P1",
    "category": "Operations",
    "component": "CI/CD quality gates",
    "file": "/tmp/time-control-hub/.github/workflows/ci.yml",
    "line": 1,
    "title": "No repository CI workflows for baseline quality controls",
    "evidence": "Baseline CI workflow added at /tmp/time-control-hub/.github/workflows/ci.yml. It runs npm ci, unit/source-contract tests (integration remains opt-in), build, and npm audit at audit-level=high; lint is currently non-blocking until lint debt is remediated.",
    "impact": "Lint, test, build, and audit regressions can reach main branch unnoticed.",
    "reproduction": "Search for workflow definitions in repository root.",
    "recommendation": "Make CI checks required on main branch. Once lint debt is reduced, flip the lint job to blocking.",
    "owner": "Platform",
    "effort": "S",
    "status": "closed"
  },
  {
    "id": "F012",
    "severity": "P1",
    "category": "Data/RLS",
    "component": "Migration consistency",
    "file": "/tmp/time-control-hub/supabase/migrations/20260106073715_1a500aeb-77da-488b-8754-4092030864f3.sql",
    "line": 62,
    "title": "Historical flipped RLS function arguments create migration drift risk",
    "evidence": "Legacy migrations include flipped calls user_belongs_to_company(company_id, auth.uid()) (see /tmp/time-control-hub/supabase/migrations/20260106073715_1a500aeb-77da-488b-8754-4092030864f3.sql and /tmp/time-control-hub/supabase/migrations/20260106094329_9f538d80-3929-4c71-9573-32bcb5964304.sql). A later fix migration exists at /tmp/time-control-hub/supabase/migrations/20260111000000_fix_rls_flipped_args.sql. Drift guard added: /tmp/time-control-hub/scripts/security/audit-rls-flipped-args.mjs (npm run security:audit-rls) with evidence output /tmp/time-control-hub/review/evidence/security_audit_rls_2026-02-06T193256Z.txt.",
    "impact": "Environments that miss or partially apply the fix can have broken access control semantics and cross-tenant policy defects.",
    "reproduction": "Compare old policy definitions with fix migration and verify deployed policy catalog per environment.",
    "recommendation": "Keep the static drift guard in CI to prevent new flipped-argument policies, and add an environment-aware policy snapshot check (against deployed pg_catalog) for staging/prod to detect partial migration application.",
    "owner": "Data/Platform",
    "effort": "M",
    "status": "open"
  },
  {
    "id": "F013",
    "severity": "P2",
    "category": "Code Quality",
    "component": "TypeScript/ESLint debt",
    "file": "/tmp/time-control-hub/review/evidence/lint_rule_counts.csv",
    "line": 2,
    "title": "High lint debt across 96 files with concentrated unsafe typing",
    "evidence": "Lint baseline reports 283 problems (266 errors, 17 warnings) in /tmp/time-control-hub/review/evidence/npm_lint.txt. Rule distribution shows 242 occurrences of @typescript-eslint/no-explicit-any and top offender files in /tmp/time-control-hub/review/evidence/lint_top_files.csv.",
    "impact": "Reduced type safety and maintainability, higher probability of runtime defects during feature changes.",
    "reproduction": "Run npm run lint on commit b786f6b.",
    "recommendation": "Execute staged lint remediation by module, starting with high-change surfaces and shared hooks/functions.",
    "owner": "Frontend/Backend",
    "effort": "L",
    "status": "open"
  },
  {
    "id": "F014",
    "severity": "P2",
    "category": "Performance",
    "component": "Frontend bundle",
    "file": "/tmp/time-control-hub/review/evidence/npm_build.txt",
    "line": 17,
    "title": "Main frontend chunk is oversized and exceeds warning threshold",
    "evidence": "Build output shows dist/assets/index-9WAKCmoF.js at 3,035.62 kB and explicit large chunk warning at line 19 in /tmp/time-control-hub/review/evidence/npm_build.txt.",
    "impact": "Slower first-load and degraded UX on low-bandwidth devices.",
    "reproduction": "Run npm run build and inspect chunk report.",
    "recommendation": "Introduce route-level dynamic imports and manual chunk strategy for heavy modules (PDF/QTSP/reporting flows).",
    "owner": "Frontend",
    "effort": "M",
    "status": "open"
  }
]
